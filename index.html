<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الشحنات المتقدم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #7E57C2;
            --primary-light: #9575CD;
            --primary-dark: #5E35B1;
            --secondary: #FF5252;
            --secondary-light: #FF867C;
            --secondary-dark: #D32F2F;
            --background: #F5F5F5;
            --text: #2D2D2D;
            --text-light: #666;
            --border: #E0E0E0;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--background);
            color: var(--text);
        }

        .sidebar-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .card-shadow-hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .input-focus {
            box-shadow: 0 0 0 3px rgba(126, 87, 194, 0.2);
        }

        .sidebar-item::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 60%;
            width: 4px;
            background: var(--secondary);
            border-radius: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-item:hover::after {
            opacity: 1;
        }

        .gradient-bg {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .price-tag {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
        }

        .status-received {
            background-color: #2196F3;
            color: white;
        }

        .status-shipped {
            background-color: #FF9800;
            color: white;
        }

        .status-delivered {
            background-color: #4CAF50;
            color: white;
        }

        .status-iraq {
            background-color: #9C27B0;
            color: white;
        }

        .animate-bounce {
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(-5px);
            }
            50% {
                transform: translateY(5px);
            }
        }

        .wave-bg {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            overflow: hidden;
            line-height: 0;
        }

        .wave-bg svg {
            position: relative;
            display: block;
            width: calc(100% + 1.3px);
            height: 150px;
        }

        .wave-bg .shape-fill {
            fill: rgba(126, 87, 194, 0.1);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#7E57C2',
                            light: '#9575CD',
                            dark: '#5E35B1'
                        },
                        secondary: {
                            DEFAULT: '#FF5252',
                            light: '#FF867C',
                            dark: '#D32F2F'
                        }
                    },
                    fontFamily: {
                        'tajawal': ['Tajawal', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="font-tajawal">
    <!-- لوحة التحكم -->
    <div id="dashboardContainer" class="min-h-screen bg-gray-50">
        <!-- شريط الأدوات العلوي -->
        <header class="bg-primary text-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <button onclick="toggleSidebar()" class="inline-flex items-center justify-center p-2 rounded-md text-white hover:bg-primary-dark focus:outline-none transition">
                            <i class="fas fa-bars text-xl"></i>
                            <span class="mr-2 text-sm font-medium">القائمة</span>
                        </button>
                    </div>
                    
                    <div class="flex items-center">
                        <div class="ml-4 flex items-center md:ml-6">
                            <div class="ml-3 relative">
                                <div>
                                    <button type="button" class="max-w-xs flex items-center text-sm rounded-full focus:outline-none" id="user-menu" aria-expanded="false" aria-haspopup="true">
                                        <span class="sr-only">فتح قائمة المستخدم</span>
                                        <div class="h-8 w-8 rounded-full bg-primary-light flex items-center justify-center">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <span class="mr-2 text-sm font-medium">المشرف</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- القائمة الجانبية -->
        <div id="sidebar" class="fixed top-0 right-0 w-64 h-full bg-white shadow-lg transform translate-x-full sidebar-transition z-50">
            <div class="flex items-center justify-between p-4 border-b">
                <div class="flex items-center">
                    <div class="h-10 w-10 rounded-full bg-primary-light flex items-center justify-center text-white">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <h3 class="text-lg font-bold text-primary mr-2">إدارة الشحنات</h3>
                </div>
                <button onclick="toggleSidebar()" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <nav class="p-4 space-y-1">
                <button onclick="showSection('dashboard')" class="w-full flex items-center p-3 text-base font-medium rounded-lg sidebar-item hover:bg-gray-100 relative transition">
                    <i class="fas fa-chart-pie ml-2 text-primary"></i>
                    <span>الإحصائيات</span>
                </button>
                
                <button onclick="showSection('users')" class="w-full flex items-center p-3 text-base font-medium rounded-lg sidebar-item hover:bg-gray-100 relative transition">
                    <i class="fas fa-users ml-2 text-primary"></i>
                    <span>إدارة المستخدمين</span>
                </button>
                
                <button onclick="showSection('shipments')" class="w-full flex items-center p-3 text-base font-medium rounded-lg sidebar-item hover:bg-gray-100 relative transition">
                    <i class="fas fa-truck ml-2 text-primary"></i>
                    <span>إدارة الشحنات</span>
                </button>
                
                <button onclick="showSection('profits')" class="w-full flex items-center p-3 text-base font-medium rounded-lg sidebar-item hover:bg-gray-100 relative transition">
                    <i class="fas fa-money-bill-wave ml-2 text-primary"></i>
                    <span>الأرباح الفردية</span>
                </button>
            </nav>
            
        </div>

        <!-- المحتوى الرئيسي -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- لوحة الإحصائيات -->
            <div id="dashboard" class="section">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-chart-line text-primary ml-2"></i>
                    نظرة عامة على النظام
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-md overflow-hidden transition transform hover:-translate-y-1">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-purple-100 text-primary">
                                    <i class="fas fa-users text-xl"></i>
                                </div>
                                <div class="mr-4">
                                    <p class="text-sm font-medium text-gray-500">عدد المستخدمين</p>
                                    <p id="usersCount" class="text-2xl font-semibold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-md overflow-hidden transition transform hover:-translate-y-1">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                                    <i class="fas fa-boxes text-xl"></i>
                                </div>
                                <div class="mr-4">
                                    <p class="text-sm font-medium text-gray-500">عدد الشحنات</p>
                                    <p id="shipmentsCount" class="text-2xl font-semibold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-md overflow-hidden transition transform hover:-translate-y-1">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-500">
                                    <i class="fas fa-money-bill-wave text-xl"></i>
                                </div>
                                <div class="mr-4">
                                    <p class="text-sm font-medium text-gray-500">المبلغ الكلي</p>
                                    <p id="totalAmount" class="text-2xl font-semibold text-gray-800">0 دينار</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-md overflow-hidden transition transform hover:-translate-y-1">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-yellow-100 text-yellow-500">
                                    <i class="fas fa-weight text-xl"></i>
                                </div>
                                <div class="mr-4">
                                    <p class="text-sm font-medium text-gray-500">الوزن الكلي</p>
                                    <p id="totalWeight" class="text-2xl font-semibold text-gray-800">0 كغم</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-history text-primary ml-2"></i>
                            آخر الشحنات المضافة
                        </h3>
                        <div id="recentShipments" class="space-y-3">
                            <div class="animate-pulse flex space-x-4">
                                <div class="flex-1 space-y-4 py-1">
                                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                                    <div class="space-y-2">
                                        <div class="h-4 bg-gray-200 rounded"></div>
                                        <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-chart-bar text-primary ml-2"></i>
                            إحصائيات سريعة
                        </h3>
                        <div id="quickStats" class="space-y-3">
                            <div class="animate-pulse flex space-x-4">
                                <div class="flex-1 space-y-4 py-1">
                                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                                    <div class="space-y-2">
                                        <div class="h-4 bg-gray-200 rounded"></div>
                                        <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- إدارة المستخدمين -->
            <div id="users" class="section" style="display: none;">
                <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                    <div class="p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-users-cog text-primary ml-2"></i>
                            إدارة المستخدمين
                        </h2>
                        
                        <form id="userForm" onsubmit="handleUserSubmit(event)" class="space-y-4">
                            <input type="hidden" id="editUserId">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-1">اسم المستخدم</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-user text-gray-400"></i>
                                        </div>
                                        <input type="text" id="newUsername" placeholder="أدخل اسم المستخدم" required 
                                               class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-lock text-gray-400"></i>
                                        </div>
                                        <input type="password" id="newPassword" placeholder="أدخل كلمة المرور" required 
                                               class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="province" class="block text-sm font-medium text-gray-700 mb-1">المحافظة</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-map-marker-alt text-gray-400"></i>
                                        </div>
                                        <input type="text" id="province" placeholder="أدخل المحافظة" required 
                                               class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">العنوان</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-home text-gray-400"></i>
                                        </div>
                                        <input type="text" id="address" placeholder="أدخل العنوان" required 
                                               class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="phone1" class="block text-sm font-medium text-gray-700 mb-1">الرقم الأول</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-phone text-gray-400"></i>
                                        </div>
                                        <input type="tel" id="phone1" placeholder="أدخل الرقم الأول" required 
                                               class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="phone2" class="block text-sm font-medium text-gray-700 mb-1">الرقم الثاني</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-phone-alt text-gray-400"></i>
                                        </div>
                                        <input type="tel" id="phone2" placeholder="أدخل الرقم الثاني" required 
                                               class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-end space-x-3 pt-4">
                                <button type="button" onclick="cancelEdit()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">
                                    <i class="fas fa-times ml-2"></i>
                                    إلغاء
                                </button>
                                <button type="submit" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition flex items-center">
                                    <i class="fas fa-save ml-2"></i>
                                    حفظ التغييرات
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                            <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-list-ul text-primary ml-2"></i>
                                المستخدمون المسجلون
                            </h3>
                            
                            <div class="mt-4 md:mt-0 relative">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="searchUsers" placeholder="ابحث بالمستخدم..." onkeyup="searchUsers()"
                                       class="w-full md:w-64 pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition">
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <div id="usersContainer" class="space-y-3">
                                <div class="animate-pulse flex space-x-4">
                                    <div class="flex-1 space-y-4 py-1">
                                        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                                        <div class="space-y-2">
                                            <div class="h-4 bg-gray-200 rounded"></div>
                                            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- إدارة الشحنات -->
            <div id="shipments" class="section" style="display: none;">
                <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                    <div class="p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-truck-loading text-primary ml-2"></i>
                            إدارة الشحنات
                        </h2>
                        
                        <form id="shipmentForm" onsubmit="handleShipmentSubmit(event)" class="space-y-4">
                            <input type="hidden" id="editShipmentId">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="user" class="block text-sm font-medium text-gray-700 mb-1">اختر المستخدم</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-user-tag text-gray-400"></i>
                                        </div>
                                        <select id="user" class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition appearance-none" required>
                                            <option value="">اختر مستخدم...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="shipmentNumber" class="block text-sm font-medium text-gray-700 mb-1">رقم الشحنة</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-barcode text-gray-400"></i>
                                        </div>
                                        <input type="text" id="shipmentNumber" required pattern="\d{8}-\d{6}" title="التنسيق: YYYYMMDD-123456"
                                               class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">الوزن (كغم)</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-weight-hanging text-gray-400"></i>
                                        </div>
                                        <input type="number" id="weight" placeholder="أدخل وزن الشحنة" step="any" min="0.01" required oninput="calculatePrice()"
                                               class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="price" class="block text-sm font-medium text-gray-700 mb-1">السعر (دينار)</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-money-bill-wave text-gray-400"></i>
                                        </div>
                                        <input type="number" id="price" placeholder="سوف يتم حساب السعر تلقائياً" readonly required
                                               class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition bg-gray-50">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">حالة الشحنة</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-info-circle text-gray-400"></i>
                                        </div>
                                        <select id="status" class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition appearance-none" required>
                                            <option value="تم الاستلام في الكويت">تم الاستلام في الكويت</option>
                                            <option value="تم الشحن للعراق">تم الشحن للعراق</option>
                                            <option value="تم الاستلام في العراق">تم الاستلام في العراق</option>
                                            <option value="تم التسليم">تم التسليم</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="priceInfo" class="p-3 bg-blue-50 text-blue-700 rounded-lg text-sm">
                                سعر الشحنة سيتم حسابه تلقائياً حسب الوزن
                            </div>
                            
                            <div class="flex items-center justify-end space-x-3 pt-4">
                                <button type="button" onclick="cancelEdit()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">
                                    <i class="fas fa-times ml-2"></i>
                                    إلغاء
                                </button>
                                <button type="submit" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition flex items-center">
                                    <i class="fas fa-save ml-2"></i>
                                    حفظ الشحنة
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                            <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-clipboard-list text-primary ml-2"></i>
                                سجل الشحنات
                            </h3>
                            
                            <div class="mt-4 md:mt-0 relative">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="searchShipments" placeholder="ابحث بالشحنات..." onkeyup="searchShipments()"
                                       class="w-full md:w-64 pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition">
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <div id="shipmentsContainer" class="space-y-3">
                                <div class="animate-pulse flex space-x-4">
                                    <div class="flex-1 space-y-4 py-1">
                                        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                                        <div class="space-y-2">
                                            <div class="h-4 bg-gray-200 rounded"></div>
                                            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- الأرباح الفردية -->
            <div id="profits" class="section" style="display: none;">
                <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                    <div class="p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-money-bill-wave text-primary ml-2"></i>
                            الأرباح الفردية
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- استاذ كاظم -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-md">
                                <div class="flex items-center mb-4">
                                    <div class="h-12 w-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mr-3">
                                        <i class="fas fa-user-tie text-xl"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-800">استاذ كاظم</h3>
                                </div>
                                <div class="bg-purple-50 rounded-lg p-4 mb-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-purple-700 font-medium">حصة الأرباح:</span>
                                        <span class="text-purple-700 font-bold">40%</span>
                                    </div>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-gray-600">المبلغ:</span>
                                        <span id="kadhimProfit" class="text-xl font-bold text-green-600">0 دينار</span>
                                    </div>
                                </div>
                                <button onclick="withdrawProfit('kadhim')" class="w-full py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition flex items-center justify-center">
                                    <i class="fas fa-coins ml-2"></i>
                                    سحب الأرباح
                                </button>
                                <div class="mt-4">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <i class="fas fa-history ml-2"></i>
                                        سجل السحب
                                    </h4>
                                    <div id="kadhimWithdrawals" class="space-y-2 text-sm text-gray-600">
                                        <!-- Withdrawal history will appear here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- استاذ مجتبى -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-md">
                                <div class="flex items-center mb-4">
                                    <div class="h-12 w-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-3">
                                        <i class="fas fa-user-tie text-xl"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-800">استاذ مجتبى</h3>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 mb-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-blue-700 font-medium">حصة الأرباح:</span>
                                        <span class="text-blue-700 font-bold">40%</span>
                                    </div>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-gray-600">المبلغ:</span>
                                        <span id="mujtabaProfit" class="text-xl font-bold text-green-600">0 دينار</span>
                                    </div>
                                </div>
                                <button onclick="withdrawProfit('mujtaba')" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition flex items-center justify-center">
                                    <i class="fas fa-coins ml-2"></i>
                                    سحب الأرباح
                                </button>
                                <div class="mt-4">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <i class="fas fa-history ml-2"></i>
                                        سجل السحب
                                    </h4>
                                    <div id="mujtabaWithdrawals" class="space-y-2 text-sm text-gray-600">
                                        <!-- Withdrawal history will appear here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- شريك الكويت -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-md">
                                <div class="flex items-center mb-4">
                                    <div class="h-12 w-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center mr-3">
                                        <i class="fas fa-handshake text-xl"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-800">شريك الكويت</h3>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 mb-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-green-700 font-medium">حصة الأرباح:</span>
                                        <span class="text-green-700 font-bold">20%</span>
                                    </div>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-gray-600">المبلغ:</span>
                                        <span id="kuwaitProfit" class="text-xl font-bold text-green-600">0 دينار</span>
                                    </div>
                                </div>
                                <button onclick="withdrawProfit('kuwait')" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition flex items-center justify-center">
                                    <i class="fas fa-coins ml-2"></i>
                                    سحب الأرباح
                                </button>
                                <div class="mt-4">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <i class="fas fa-history ml-2"></i>
                                        سجل السحب
                                    </h4>
                                    <div id="kuwaitWithdrawals" class="space-y-2 text-sm text-gray-600">
                                        <!-- Withdrawal history will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCKIaGp7rycn2Si88mc5VXfn0iQazvLT_c",
            authDomain: "wasel-910f9.firebaseapp.com",
            databaseURL: "https://wasel-910f9-default-rtdb.firebaseio.com",
            projectId: "wasel-910f9",
            storageBucket: "wasel-910f9.appspot.com",
            messagingSenderId: "45165850758",
            appId: "1:45165850758:web:9a423737071789d2ffe107",
            measurementId: "G-KCD23STGQX"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let allUsers = [];
        let allShipments = [];

        window.addEventListener('load', () => {
            initializeDashboard();
        });


        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('translate-x-full');
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
            
            if (sectionId === 'profits') {
                calculateProfits();
            }
            
            toggleSidebar();
        }

        function handleUserSubmit(e) {
            e.preventDefault();
            const userData = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                province: document.getElementById('province').value,
                address: document.getElementById('address').value,
                phone1: document.getElementById('phone1').value,
                phone2: document.getElementById('phone2').value,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            const userId = document.getElementById('editUserId').value;
            if (userId) {
                database.ref(`users/${userId}`).update(userData);
            } else {
                database.ref('users').push(userData);
            }
            resetForms();
        }

        function renderUsers() {
            database.ref('users').on('value', snapshot => {
                allUsers = [];
                snapshot.forEach(child => {
                    allUsers.push({
                        key: child.key,
                        ...child.val()
                    });
                });
                renderUsersList(allUsers);
                updateRecentUsers();
            });
        }

        function renderUsersList(users) {
            const container = document.getElementById('usersContainer');
            container.innerHTML = '';
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-user-slash text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">لا يوجد مستخدمون مسجلون بعد</p>
                    </div>
                `;
                return;
            }
            
            users.forEach(user => {
                const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('ar-EG') : 'غير معروف';
                
                container.innerHTML += `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                            <div class="mb-3 md:mb-0">
                                <h4 class="font-medium text-lg text-gray-800">${user.username}</h4>
                                <div class="flex items-center text-sm text-gray-500 mt-1">
                                    <i class="fas fa-map-marker-alt ml-1"></i>
                                    <span>${user.province}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-500 mt-1">
                                    <i class="fas fa-phone ml-1"></i>
                                    <span>${user.phone1}</span>
                                    ${user.phone2 ? `<span class="mr-2">/ ${user.phone2}</span>` : ''}
                                </div>
                                <div class="text-xs text-gray-400 mt-2">
                                    <i class="far fa-calendar-alt ml-1"></i>
                                    ${createdAt}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editUser('${user.key}')" class="px-3 py-1 bg-primary hover:bg-primary-dark text-white text-sm rounded-lg transition flex items-center">
                                    <i class="fas fa-edit ml-1"></i>
                                    تعديل
                                </button>
                                <button onclick="deleteUser('${user.key}')" class="px-3 py-1 bg-secondary hover:bg-secondary-dark text-white text-sm rounded-lg transition flex items-center">
                                    <i class="fas fa-trash-alt ml-1"></i>
                                    حذف
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function updateRecentUsers() {
            const recentUsers = allUsers.slice(0, 5);
            let html = '';
            
            recentUsers.forEach(user => {
                html += `
                    <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition">
                        <div class="flex items-center">
                            <div class="h-10 w-10 rounded-full bg-purple-100 text-primary flex items-center justify-center">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="mr-3">
                                <h4 class="font-medium">${user.username}</h4>
                                <p class="text-sm text-gray-500">${user.province}</p>
                            </div>
                        </div>
                        <span class="text-xs text-gray-400">${user.phone1}</span>
                    </div>
                `;
            });
            
            document.getElementById('quickStats').innerHTML = html;
        }

        function searchUsers() {
            const term = document.getElementById('searchUsers').value.toLowerCase();
            const filtered = allUsers.filter(user =>
                user.username.toLowerCase().includes(term) ||
                user.province.toLowerCase().includes(term) ||
                user.phone1.includes(term) ||
                user.phone2.includes(term)
            );
            renderUsersList(filtered);
        }

        function editUser(userId) {
            database.ref(`users/${userId}`).once('value').then(snapshot => {
                const user = snapshot.val();
                document.getElementById('editUserId').value = userId;
                document.getElementById('newUsername').value = user.username;
                document.getElementById('newPassword').value = user.password;
                document.getElementById('province').value = user.province;
                document.getElementById('address').value = user.address;
                document.getElementById('phone1').value = user.phone1;
                document.getElementById('phone2').value = user.phone2;
                window.scrollTo(0, 0);
            });
        }

        function deleteUser(userId) {
            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                database.ref(`users/${userId}`).remove();
            }
        }

        function generateShipmentNumber() {
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const random = Math.floor(100000 + Math.random() * 900000);
            return `${date}-${random}`;
        }

        function calculatePrice() {
            const weightInput = document.getElementById('weight');
            const priceInput = document.getElementById('price');
            const priceInfo = document.getElementById('priceInfo');

            const weight = parseFloat(weightInput.value);
            if (isNaN(weight) || weight <= 0) {
                priceInput.value = '';
                priceInfo.textContent = 'سعر الشحنة سيتم حسابه تلقائياً حسب الوزن';
                priceInfo.className = 'p-3 bg-blue-50 text-blue-700 rounded-lg text-sm';
                return;
            }

            let price = 0;
            let additionalInfo = '';

            if (weight > 0 && weight < 1) {
                price = 3500;
                additionalInfo = '(سعر ثابت 3,500 دينار لأقل من 1 كغم)';
                priceInfo.className = 'p-3 bg-green-50 text-green-700 rounded-lg text-sm';
            } else if (weight >= 1 && weight < 10) {
                price = weight * 3500;
                price = Math.ceil(price);
                additionalInfo = `(السعر: ${weight} × 3500 دينار لكل كغم)`;
                priceInfo.className = 'p-3 bg-green-50 text-green-700 rounded-lg text-sm';
            } else if (weight >= 10) {
                price = 38000; // Keep original price here
                additionalInfo = `(سعر ثابت 38,000 دينار من 10 كغم فما فوق)`;
                priceInfo.className = 'p-3 bg-purple-50 text-purple-700 rounded-lg text-sm';
            } else {
                priceInput.value = '';
                priceInfo.textContent = 'وزن غير صالح';
                priceInfo.className = 'p-3 bg-red-50 text-red-700 rounded-lg text-sm';
                return;
            }

            priceInput.value = price;
            priceInfo.textContent = `تم حساب السعر تلقائياً ${additionalInfo}`;
        }

        function handleShipmentSubmit(e) {
            e.preventDefault();
            const shipmentData = {
                userId: document.getElementById('user').value,
                number: document.getElementById('shipmentNumber').value,
                weight: parseFloat(document.getElementById('weight').value),
                price: parseInt(document.getElementById('price').value),
                status: document.getElementById('status').value,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            const shipmentId = document.getElementById('editShipmentId').value;
            if (shipmentId) {
                database.ref(`shipments/${shipmentId}`).update(shipmentData);
            } else {
                database.ref('shipments').push(shipmentData);
            }
            resetForms();
        }

        function renderShipments() {
            database.ref('shipments').on('value', async snapshot => {
                allShipments = [];
                const usersSnapshot = await database.ref('users').once('value');
                const users = usersSnapshot.val();

                snapshot.forEach(child => {
                    const shipment = child.val();
                    allShipments.push({
                        key: child.key,
                        ...shipment,
                        user: users ? users[shipment.userId] : null
                    });
                });
                renderShipmentsList(allShipments);
                updateRecentShipments();
            });
        }

        function renderShipmentsList(shipments) {
            const container = document.getElementById('shipmentsContainer');
            container.innerHTML = '';
            
            if (shipments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-box-open text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">لا يوجد شحنات مسجلة بعد</p>
                    </div>
                `;
                return;
            }
            
            shipments.forEach(shipment => {
                const createdAt = shipment.createdAt ? new Date(shipment.createdAt).toLocaleDateString('ar-EG') : 'غير معروف';
                const statusClass = getStatusClass(shipment.status);
                
                container.innerHTML += `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                            <div class="mb-3 md:mb-0">
                                <div class="flex items-center">
                                    <h4 class="font-medium text-lg text-gray-800">${shipment.number}</h4>
                                    <span class="${statusClass} text-xs px-2 py-1 rounded-full mr-2">${shipment.status}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-500 mt-1">
                                    <i class="fas fa-user ml-1"></i>
                                    <span>${shipment.user ? shipment.user.username : 'غير معروف'}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-500 mt-1">
                                    <i class="fas fa-weight-hanging ml-1"></i>
                                    <span>${shipment.weight} كغم</span>
                                    <span class="mr-3"></span>
                                    <i class="fas fa-money-bill-wave ml-1"></i>
                                    <span>${shipment.price.toLocaleString()} دينار</span>
                                </div>
                                <div class="text-xs text-gray-400 mt-2">
                                    <i class="far fa-calendar-alt ml-1"></i>
                                    ${createdAt}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editShipment('${shipment.key}')" class="px-3 py-1 bg-primary hover:bg-primary-dark text-white text-sm rounded-lg transition flex items-center">
                                    <i class="fas fa-edit ml-1"></i>
                                    تعديل
                                </button>
                                <button onclick="deleteShipment('${shipment.key}')" class="px-3 py-1 bg-secondary hover:bg-secondary-dark text-white text-sm rounded-lg transition flex items-center">
                                    <i class="fas fa-trash-alt ml-1"></i>
                                    حذف
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function getStatusClass(status) {
            switch(status) {
                case 'تم الاستلام في الكويت':
                    return 'status-received';
                case 'تم الشحن للعراق':
                    return 'status-shipped';
                case 'تم الاستلام في العراق':
                    return 'status-iraq';
                case 'تم التسليم':
                    return 'status-delivered';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function updateRecentShipments() {
            const recentShipments = allShipments.slice(0, 5);
            let html = '';
            
            recentShipments.forEach(shipment => {
                const statusClass = getStatusClass(shipment.status);
                
                html += `
                    <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition">
                        <div class="flex items-center">
                            <div class="h-10 w-10 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="mr-3">
                                <h4 class="font-medium">${shipment.number}</h4>
                                <p class="text-sm text-gray-500">${shipment.user ? shipment.user.username : 'غير معروف'}</p>
                            </div>
                        </div>
                        <span class="${statusClass} text-xs px-2 py-1 rounded-full">${shipment.status}</span>
                    </div>
                `;
            });
            
            document.getElementById('recentShipments').innerHTML = html;
        }

        function searchShipments() {
            const term = document.getElementById('searchShipments').value.toLowerCase();
            const filtered = allShipments.filter(shipment =>
                shipment.number.toLowerCase().includes(term) ||
                shipment.status.toLowerCase().includes(term) ||
                (shipment.user && shipment.user.username.toLowerCase().includes(term))
            );
            renderShipmentsList(filtered);
        }

        function loadUsersToSelect() {
            database.ref('users').on('value', snapshot => {
                const userSelect = document.getElementById('user');
                userSelect.innerHTML = '<option value="">اختر مستخدم...</option>';
                let users = [];
                snapshot.forEach(child => {
                    users.push({
                        key: child.key,
                        ...child.val()
                    });
                });

                users.sort((a, b) => a.username.localeCompare(b.username, 'ar'));

                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.key;
                    option.textContent = `${user.username} - ${user.province}`;
                    userSelect.appendChild(option);
                });
            });
        }

        function editShipment(shipmentId) {
            database.ref(`shipments/${shipmentId}`).once('value').then(snapshot => {
                const shipment = snapshot.val();
                document.getElementById('editShipmentId').value = shipmentId;
                document.getElementById('user').value = shipment.userId;
                document.getElementById('shipmentNumber').value = shipment.number;
                document.getElementById('weight').value = shipment.weight;
                document.getElementById('price').value = shipment.price;
                document.getElementById('status').value = shipment.status;
                document.getElementById('priceInfo').textContent = 'سعر الشحنة محسوب مسبقاً';
                document.getElementById('priceInfo').className = 'p-3 bg-blue-50 text-blue-700 rounded-lg text-sm';
                window.scrollTo(0, 0);
            });
        }

        function deleteShipment(shipmentId) {
            if (confirm('هل أنت متأكد من حذف هذه الشحنة؟')) {
                database.ref(`shipments/${shipmentId}`).remove();
            }
        }

        function initializeDashboard() {
            document.getElementById('dashboardContainer').style.display = 'block';
            document.getElementById('shipmentNumber').value = generateShipmentNumber();
            updateStatistics();
            renderUsers();
            renderShipments();
            loadUsersToSelect();
        }

        function updateStatistics() {
            database.ref('users').on('value', snapshot => {
                document.getElementById('usersCount').textContent = snapshot.numChildren().toLocaleString();
            });

            database.ref('shipments').on('value', snapshot => {
                let totalAmount = 0, totalWeight = 0;
                snapshot.forEach(child => {
                    const shipment = child.val();
                    let price = shipment.price || 0;
                    // Subtract 5000 for shipments 10kg or more in statistics only
                    if (shipment.weight >= 10) {
                        price = Math.max(0, price - 5000);
                    }
                    totalAmount += price;
                    totalWeight += shipment.weight || 0;
                });
                document.getElementById('shipmentsCount').textContent = snapshot.numChildren().toLocaleString();
                document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + ' دينار';
                document.getElementById('totalWeight').textContent = totalWeight.toLocaleString() + ' كغم';
            });
        }

        function resetForms() {
            document.getElementById('userForm').reset();
            document.getElementById('shipmentForm').reset();
            document.getElementById('editUserId').value = '';
            document.getElementById('editShipmentId').value = '';
            document.getElementById('shipmentNumber').value = generateShipmentNumber();
            document.getElementById('user').selectedIndex = 0;
            document.getElementById('priceInfo').textContent = 'سعر الشحنة سيتم حسابه تلقائياً حسب الوزن';
            document.getElementById('priceInfo').className = 'p-3 bg-blue-50 text-blue-700 rounded-lg text-sm';
        }

        function cancelEdit() {
            resetForms();
        }

        // Profit management functions
        function calculateProfits() {
            // Get the total amount from dashboard statistics
            const totalAmountText = document.getElementById('totalAmount').textContent;
            const totalAmount = parseInt(totalAmountText.replace(/[^0-9]/g, '')) || 0;

            // Calculate individual shares (40%, 40%, 20%)
            const kadhimShare = Math.floor(totalAmount * 0.4);
            const mujtabaShare = Math.floor(totalAmount * 0.4);
            const kuwaitShare = Math.floor(totalAmount * 0.2);

            // Update profit displays
            document.getElementById('kadhimProfit').textContent = kadhimShare.toLocaleString() + ' دينار';
            document.getElementById('mujtabaProfit').textContent = mujtabaShare.toLocaleString() + ' دينار';
            document.getElementById('kuwaitProfit').textContent = kuwaitShare.toLocaleString() + ' دينار';

            // Store current profits in database
            database.ref('profits').set({
                kadhim: kadhimShare,
                mujtaba: mujtabaShare,
                kuwait: kuwaitShare
            });

            // Load withdrawal history
            loadWithdrawalHistory();
        }

        function withdrawProfit(person) {
            const profitElement = document.getElementById(`${person}Profit`);
            const currentProfit = parseInt(profitElement.textContent.replace(/[^0-9]/g, '')) || 0;
            
            if (currentProfit <= 0) {
                alert('لا يوجد أرباح متاحة للسحب');
                return;
            }

            if (confirm(`هل تريد سحب ${currentProfit.toLocaleString()} دينار من أرباح ${getPersonName(person)}؟`)) {
                // Record withdrawal
                const withdrawalData = {
                    amount: currentProfit,
                    date: firebase.database.ServerValue.TIMESTAMP,
                    person: person
                };
                
                database.ref('withdrawals').push(withdrawalData);

                // Reset profit to zero
                database.ref(`profits/${person}`).set(0);
                profitElement.textContent = '0 دينار';
                
                // Update withdrawal history
                loadWithdrawalHistory();
            }
        }

        function getPersonName(person) {
            switch(person) {
                case 'kadhim': return 'استاذ كاظم';
                case 'mujtaba': return 'استاذ مجتبى';
                case 'kuwait': return 'شريك الكويت';
                default: return '';
            }
        }

        function loadWithdrawalHistory() {
            database.ref('withdrawals').orderByChild('date').limitToLast(5).once('value').then(snapshot => {
                const withdrawals = [];
                snapshot.forEach(child => {
                    withdrawals.push({
                        key: child.key,
                        ...child.val()
                    });
                });

                // Clear existing histories
                document.getElementById('kadhimWithdrawals').innerHTML = '';
                document.getElementById('mujtabaWithdrawals').innerHTML = '';
                document.getElementById('kuwaitWithdrawals').innerHTML = '';

                // Add withdrawals to respective sections
                withdrawals.forEach(withdrawal => {
                    const date = new Date(withdrawal.date).toLocaleDateString('ar-EG');
                    const item = document.createElement('div');
                    item.textContent = `${withdrawal.amount.toLocaleString()} دينار - ${date}`;
                    
                    document.getElementById(`${withdrawal.person}Withdrawals`).prepend(item);
                });
            });
        }

        // Profit management functions
        function calculateProfits() {
            database.ref('shipments').once('value').then(snapshot => {
                let totalProfits = 0;
                snapshot.forEach(child => {
                    const shipment = child.val();
                    totalProfits += shipment.price || 0;
                });

                // Calculate individual shares (40%, 40%, 20%)
                const kadhimShare = Math.floor(totalProfits * 0.4);
                const mujtabaShare = Math.floor(totalProfits * 0.4);
                const kuwaitShare = Math.floor(totalProfits * 0.2);

                // Update profit displays
                document.getElementById('kadhimProfit').textContent = kadhimShare.toLocaleString() + ' دينار';
                document.getElementById('mujtabaProfit').textContent = mujtabaShare.toLocaleString() + ' دينار';
                document.getElementById('kuwaitProfit').textContent = kuwaitShare.toLocaleString() + ' دينار';

                // Store current profits in database
                database.ref('profits').set({
                    kadhim: kadhimShare,
                    mujtaba: mujtabaShare,
                    kuwait: kuwaitShare
                });
            });

            // Load withdrawal history
            loadWithdrawalHistory();
        }

        function withdrawProfit(person) {
            const profitElement = document.getElementById(`${person}Profit`);
            const currentProfit = parseInt(profitElement.textContent.replace(/[^0-9]/g, '')) || 0;
            
            if (currentProfit <= 0) {
                alert('لا يوجد أرباح متاحة للسحب');
                return;
            }

            if (confirm(`هل تريد سحب ${currentProfit.toLocaleString()} دينار من أرباح ${getPersonName(person)}؟`)) {
                // Record withdrawal
                const withdrawalData = {
                    amount: currentProfit,
                    date: firebase.database.ServerValue.TIMESTAMP,
                    person: person
                };
                
                database.ref('withdrawals').push(withdrawalData);

                // Reset profit to zero
                database.ref(`profits/${person}`).set(0);
                profitElement.textContent = '0 دينار';
                
                // Update withdrawal history
                loadWithdrawalHistory();
            }
        }

        function getPersonName(person) {
            switch(person) {
                case 'kadhim': return 'استاذ كاظم';
                case 'mujtaba': return 'استاذ مجتبى';
                case 'kuwait': return 'شريك الكويت';
                default: return '';
            }
        }

        function loadWithdrawalHistory() {
            database.ref('withdrawals').orderByChild('date').limitToLast(5).once('value').then(snapshot => {
                const withdrawals = [];
                snapshot.forEach(child => {
                    withdrawals.push({
                        key: child.key,
                        ...child.val()
                    });
                });

                // Clear existing histories
                document.getElementById('kadhimWithdrawals').innerHTML = '';
                document.getElementById('mujtabaWithdrawals').innerHTML = '';
                document.getElementById('kuwaitWithdrawals').innerHTML = '';

                // Add withdrawals to respective sections
                withdrawals.forEach(withdrawal => {
                    const date = new Date(withdrawal.date).toLocaleDateString('ar-EG');
                    const item = document.createElement('div');
                    item.textContent = `${withdrawal.amount.toLocaleString()} دينار - ${date}`;
                    
                    document.getElementById(`${withdrawal.person}Withdrawals`).prepend(item);
                });
            });
        }

        // Initialize profits when showing the section
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
            
            if (sectionId === 'profits') {
                calculateProfits();
            }
            
            toggleSidebar();
        }
    </script>
</body>
</html>
